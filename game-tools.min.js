function Game(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;this.paused=false;this.hooks=[];this.started=false;this.time=0;this.time_started=0;this.constants={MIP_MAPPING:false,GAME_SPEED:1,TILE_HEIGHT:32,TILE_WIDTH:32,PAN_MARGIN:32,PAN_SPEED:25};this.resources={init:function(){this.images={};this.sprites={};this.sounds={};this.images_to_load={}},add_image:function(e,t){this.images_to_load[e]=t},add_sprite:function(e,t,n,r){this.images_to_load[e]=t;this.sprites[e]=new Sprite(e,n,r)},load:function(e){var t=0;var n=0;for(var r in this.images_to_load){n++}if(n==0){if(e){e()}return}for(var r in this.images_to_load){this.images[r]=new Image;this.images[r].onload=function(){if(++t>=n){e()}};this.images[r].src=this.images_to_load[r]}}};this.events={init:function(){this.hooks=[];this.tile_under_mouse=[0,0];var e=this;$(window).mousedown(function(t){e.mouse_down(t)});$(window).mousemove(function(t){e.mouse_move(t)});$(window).mouseup(function(t){e.mouse_up(t)});$(window).bind("mousewheel DOMMouseScroll MozMousePixelScroll",function(t){e.mouse_wheel(t)});$("#game_overlay").mouseleave(function(t){e.mouse_move(t)});$(window).keydown(function(t){e.key_down(t)});$(window).keyup(function(t){e.key_up(t)});$(window).resize(function(){e.resize()})},mouse_down:function(e){e.preventDefault()},mouse_up:function(e){e.preventDefault()},mouse_move:function(e){e.preventDefault();this.mouse_to_tile(e.clientX,e.clientY);this.event_fired("mouse_move",e)},mouse_wheel:function(e){e.preventDefault()},mouse_leave:function(e){},key_down:function(e){this.event_fired("key_down",e)},key_up:function(e){this.event_fired("key_up",e)},resize:function(){this.event_fired("resize")},add_hook:function(e){this.hooks.push(e)},event_fired:function(e,t){for(var n=0;n<this.hooks.length;n++){ob=this.hooks[n];if(typeof ob!=="undefined"&&ob!==null){if(typeof ob[e]!=="undefined"&&ob[e]!==null){ob[e](t)}}}},mouse_to_tile:function(e,t){var n=-1*parseInt((this.game.draw.pan_x-e)/this.game.constants.TILE_WIDTH);var r=-1*parseInt((this.game.draw.pan_y-t)/this.game.constants.TILE_HEIGHT);this.tile_under_mouse=[n,r]}};this.draw={init:function(){this.layers={};this.animations=[];this.game.add_hook(this);this.game.events.add_hook(this);$("#game_area").css("left",0);$("#game_area").css("top",0);$("#game_area").css("position","fixed");$("#game_overlay").css("left",0);$("#game_overlay").css("top",0);$("#game_overlay").css("position","fixed")},add_layer:function(e,t,n){var r=$('<canvas id="can_'+e+'" class="game_canvas">');var i=r[0].getContext("2d");if(n){r.data("persistant",true)}else{r.data("persistant",false);r.data("cleared",false)}if(t){r.attr("width",this.game.viewport.screen_width);r.attr("height",this.game.viewport.screen_height);$("#game_overlay").append(r);r.data("view","overlay")}else{r.attr("width",this.game.map.width);r.attr("height",this.game.map.height);$("#game_area").append(r);r.data("view","background")}this.set_mip_mapping(this.game.constants.MIP_MAPPING);return this.layers[e]=r},image:function(e,t,n,r,i,s,o){var u=this.game.resources.images[e];var a=this.layers[t];if(u&&a){if(n==null){n=0}if(r==null){r=0}if(o==null&&s==null&&i){o=i;i=this.game.resources.images[e].width;s=this.game.resources.images[e].height}if(i==null){i=this.game.resources.images[e].width}if(s==null){s=this.game.resources.images[e].height}if(o==null){o=0}var f=a[0].getContext("2d");if(o==0){if(this.layers[t].data("persistant")==false){this.layers[t].data("cleared",false)}return f.drawImage(u,n,r,i,s)}else{f.save();f.translate(n+i/2,r+s/2);f.rotate(o);f.drawImage(u,-(i/2),-(s/2),i,s);f.restore();if(this.layers[t].data("persistant")==false){this.layers[t].data("cleared",false)}return true}}return false},sub_image:function(e,t,n,r,i,s,o,u,a,f,l){var c=this.game.resources.images[e];var h=this.layers[t];if(l==null){l=0}if(c&&h){var p=this.layers[t][0].getContext("2d");if(l==0){p.drawImage(c,o,u,a,f,n,r,i,s);return true}else{p.save();p.translate(n+i/2,r+s/2);p.rotate(l);p.drawImage(c,o,u,a,f,-(i/2),-(s/2),i,s);p.restore();return true}}return false},sub_sprite:function(e,t,n,r,i,s,o,u){var a=this.game.resources.sprites[e];var f=this.game.resources.images[e];var l=this.layers[t];if(s==null){s=this.game.constants.TILE_WIDTH}if(o==null){o=this.game.constants.TILE_HEIGHT}if(u==null){u=0}if(a&&f&&l){var c=this.layers[t][0].getContext("2d");var h=f.width/a.clips_y;var p=f.width/a.clips_x;var d=n%a.clips_x*p;var v=Math.floor(n/a.clips_y)*h;if(u==0){c.drawImage(f,d,v,p,h,r,i,s,o);return true}else{c.save();c.translate(r+s/2,i+o/2);c.rotate(u);c.drawImage(f,d,v,p,h,-(s/2),-(o/2),s,o);c.restore();return true}}return false},rectangle:function(e,t,n,r,i,s,o,u){var a=this.layers[e][0].getContext("2d");a.save();a.beginPath();a.rect(t,n,r,i);if(o){a.fillStyle=o;if(u){a.globalAlpha=u}a.fillRect(t,n,r,i)}a.globalAlpha=1;a.lineWidth=1;a.strokeStyle=s;a.stroke();a.restore();if(this.layers[e].data("persistant")==false){this.layers[e].data("cleared",false)}},clear_rectangle:function(e,t,n,r,i,s){var o=this.layers[e][0].getContext("2d");if(s==null||s==0){return o.clearRect(t,n,r,i)}o.save();o.translate(t+r/2,n+i/2);o.rotate(s);o.clearRect(-(r/2),-(i/2),r,i);o.restore()},clear_layer:function(e){var t=this.layers[e][0].getContext("2d");t.clearRect(0,0,this.screen_width,this.screen_height);this.layers[e].data("cleared",true)},animation:function(e,t,n,r,i,s,o,u,a){if(this.game.resources.images[e]){if(this.game.resources.sprites[e]){if(n==null){n="loop"}if(i==null){i=0}if(s==null){s=0}if(o==null){o=this.game.resources.images[e].width/this.game.resources.sprites[e].clips_x}if(u==null){u=this.game.resources.images[e].height/this.game.resources.sprites[e].clips_y}if(r==null){r=100}if(a==null){a=0}var f=new Animation(this.game,e,t,i,s,o,u,r,a,n);this.animations.push(f);return f}else{return false}}return false},resize:function(){$(".gui_container").css("height",$(window).height());$(".gui_container").css("width",$(window).width());for(layer in this.layers){if(this.layers[layer].data("view")=="overlay"){this.layers[layer].attr("width",this.game.viewport.screen_width);this.layers[layer].attr("height",this.game.viewport.screen_height)}}this.set_mip_mapping(this.game.constants.MIP_MAPPING)},background_resize:function(){$(".gui_container").css("height",$(window).height());$(".gui_container").css("width",$(window).width());for(layer in this.layers){if(this.layers[layer].data("view")=="background"){var e=$("#can_"+layer);e.attr("width",this.game.map.width*this.game.constants.TILE_WIDTH);e.attr("height",this.game.map.height*this.game.constants.TILE_HEIGHT)}}this.set_mip_mapping(this.game.constants.MIP_MAPPING)},set_mip_mapping:function(e){for(layer in this.layers){var t=$("#can_"+layer);var n=t[0].getContext("2d");n.imageSmoothingEnabled=e;n.mozImageSmoothingEnabled=e;n.webkitImageSmoothingEnabled=e}},move_view:function(e,t){$("#game_area").css("left",e);$("#game_area").css("top",t)},update:function(e){for(var t=0;t<this.animations.length;t++){var n=this.animations[t];n.frame_update(e);n.rotate(e/700);n.move(e/50,0);n.draw()}for(layer in this.layers){if(this.layers[layer].data("persistant")==false){if(this.layers[layer].data("cleared")==false){this.clear_layer(layer)}}}}};this.map={init:function(){this.tiles={};this.collision_layers={};this.loaded=false;this.map=[];this.layer="background";this.sprite="colors";this.width=0;this.height=0},load_sprite_map:function(e,t,n){this.sprite=t;this.map=n;this.width=n.length;this.height=n[0].length;this.game.draw.background_resize();this.game.viewport.background_resize();for(var r=0;r<n.length;r++){for(var i=0;i<n[r].length;i++){this.game.draw.sub_sprite(this.sprite,e,n[r][i],i*this.game.constants.TILE_WIDTH,r*this.game.constants.TILE_HEIGHT)}}},load_collision_map:function(e,t){for(var n=0;n<t.length;n++){for(var r=0;r<t[n].length;r++){if(t[n][r]==0){this.collision_layers[e][n][r]=false}else{this.collision_layers[e][n][r]=true}}}},check_collision:function(e,t,n){return e[t][n]},set_collision:function(e,t,n,r){this.collision_layers[e][t][n]=r},show_editor:function(){this.game.gui.show_window("window_editor",true)}};this.viewport={init:function(){this.game.add_hook(this);this.game.events.add_hook(this);this.pan_x=0;this.pan_y=0;this.panning_x=0;this.panning_y=0;this.screen_width=$(window).width();this.screen_height=$(window).height();this.max_pan_x=this.screen_width-this.game.constants.TILE_WIDTH*this.game.map.width;this.max_pan_y=this.screen_height-this.game.constants.TILE_HEIGHT*this.game.map.height},resize:function(){this.screen_width=$(window).width();this.screen_height=$(window).height();this.max_pan_x=this.screen_width-this.game.constants.TILE_WIDTH*this.game.map.width;this.max_pan_y=this.screen_height-this.game.constants.TILE_HEIGHT*this.game.map.height},background_resize:function(){this.max_pan_x=this.screen_width-this.game.constants.TILE_WIDTH*this.game.map.width;this.max_pan_y=this.screen_height-this.game.constants.TILE_HEIGHT*this.game.map.height},mouse_move:function(e){mouse_x=e.clientX;mouse_y=e.clientY;var t=this.game.constants.PAN_MARGIN;var n=this.game.constants.PAN_SPEED;if(mouse_x<=t){var r=parseInt((t-mouse_x)/t*n);if(r>n){r=n}this.panning_x=r}else if(mouse_x>=this.screen_width-t){var r=n-parseInt((this.screen_width-mouse_x)/t*n);if(r>n){r=n}this.panning_x=-1*r}else{this.panning_x=0}if(mouse_y<=t){var r=parseInt((t-mouse_y)/t*n);if(r>n){r=n}this.panning_y=r}else if(mouse_y>=this.screen_height-t){var r=n-parseInt((this.screen_height-mouse_y)/t*n);if(r>n){r=n}this.panning_y=-1*r}else{this.panning_y=0}},pan:function(){this.pan_x+=this.panning_x;this.pan_y+=this.panning_y;if(this.pan_x>0){this.pan_x=0}else if(this.pan_x<this.max_pan_x){this.pan_x=this.max_pan_x}if(this.pan_y>0){this.pan_y=0}else if(this.pan_y<this.max_pan_y){this.pan_y=this.max_pan_y}this.game.draw.move_view(this.pan_x,this.pan_y)},update:function(e){if(this.panning_x!=0||this.panning_y!=0){this.pan()}var t=this.game.events.tile_under_mouse[0]*this.game.constants.TILE_WIDTH+this.pan_x;var n=this.game.events.tile_under_mouse[1]*this.game.constants.TILE_HEIGHT+this.pan_y}};this.events.game=this;this.draw.game=this;this.map.game=this;this.viewport.game=this;this.resources.init();this.events.init();this.draw.init();this.map.init();this.viewport.init()}function Sprite(e,t,n){this.name=e;this.clips_x=t;this.clips_y=n}function Animation(e,t,n,r,i,s,o,u,a,f){this.game=e;this.sprite=this.game.resources.sprites[t];this.layer=n;this.x=r;this.y=i;this.width=s;this.height=o;this.rotation=a;this.offset_height=this.game.resources.images[t].height/this.sprite.clips_y;this.offset_width=this.game.resources.images[t].width/this.sprite.clips_x;this.clips=[this.sprite.clips_x,this.sprite.clips_y];this.clip=[0,0];this.total_frames=this.clips[0]*this.clips[1];this.paused=false;this.flip=true;this.speed=u;this.type=f;this.frame=0;this.time=0;this.needs_draw=true;this.drawn=false}Game.prototype.start=function(e){this.started=true;var t=new Date;this.time=t.getTime();this.time_started=this.time;var n=this;var r=e;this.resources.load(function(){n.update(n);if(r){r()}})},Game.prototype.pause=function(){if(!this.paused&&this.started){this.paused=true}},Game.prototype.unpause=function(){if(this.paused&&this.started){var e=new Date;this.time=e.getTime();this.paused=false;this.update(this)}},Game.prototype.set_speed=function(){this.constants.GAME_SPEED=speed},Game.prototype.add_hook=function(e){if(typeof e.update==="function"){this.hooks.push(e);return true}return false},Game.prototype.update=function(e){if(!e.paused&&e.started){var t=(new Date).getTime();var n=(t-(e.time||t))*e.constants.GAME_SPEED;e.time=t;if(e.hooks){for(var r=0;r<e.hooks.length;r++){e.hooks[r].update(n)}}requestAnimationFrame(function(){e.update(e)})}};Animation.prototype.clear=function(){this.game.draw.clear_rectangle(this.layer,this.x,this.y,this.width,this.height,this.rotation);this.drawn=false;this.needs_draw=true};Animation.prototype.clip_increment=function(e){if(this.type=="loop"){this.frame=(this.frame+e)%this.total_frames;var t=this.frame%this.clips[0];var n=Math.floor(this.frame/this.clips[0]);this.clip=[t,n];this.needs_draw=true}else if(this.type=="flip"){if(this.flip){this.frame=this.frame+e;if(this.frame>=this.total_frames){this.frame=this.total_frames-1}else{this.needs_draw=true}var t=this.frame%this.clips[0];if(this.clips[1]!=1){var n=Math.floor(this.frame/this.clips[1])}else{var n=0}this.clip=[t,n]}else{this.frame=this.frame-e;if(this.frame<=0){this.frame=0}else{this.needs_draw=true}var t=this.frame%this.clips[0];if(this.clips[1]!=1){var n=Math.floor(this.frame/this.clips[1])}else{var n=0}this.clip=[t,n]}}else if(this.type=="property"){if(this.frame!=this.prop["prop"]){this.frame=this.prop["prop"];if(this.frame>=this.total_frames){this.frame=this.total_frames-1}else{this.needs_draw=true}var t=this.frame%this.clips[0];if(this.clips[1]!=1){var n=Math.floor(this.frame/this.clips[1])}else{var n=0}this.clip=[t,n]}else{this.needs_draw=false}}return this.frame};Animation.prototype.frame_update=function(e){this.time+=e;var t=Math.floor(this.time/this.speed);if(t>0){this.clip_increment(t);this.time%=this.speed}};Animation.prototype.draw=function(){if(this.needs_draw){var e=this.clip[0]*this.offset_width;var t=this.clip[1]*this.offset_height;if(this.drawn){this.clear()}this.drawn=this.game.draw.sub_image(this.sprite.name,this.layer,this.x,this.y,this.width,this.height,e,t,this.offset_width,this.offset_height,this.rotation);this.needs_draw=!this.drawn}return this.needs_draw};Animation.prototype.rotate=function(e){if(this.drawn){this.clear()}this.rotation+=e};Animation.prototype.move=function(e,t){if(this.drawn){this.clear()}this.x+=e;this.y+=t}